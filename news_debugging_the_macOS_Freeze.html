<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hype Coding a Hong Kong Dream - Lorye Go! News</title>
    <link rel="icon" type="image/x-icon" href="pics/game_icon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        header {
            background-color: #5f1a04;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid #34495e;
        }
        header .logo {
            max-width: 200px;
            height: auto;
            margin-bottom: 10px;
        }
        header h1 {
            margin: 0;
            font-size: 2em;
        }
        header nav {
            margin-top: 10px;
        }
        header nav a {
            color: #ecf0f1;
            margin: 0 15px;
            font-weight: 700;
        }
        .content {
            max-width: 700px;
            margin: 40px auto;
            padding: 0 20px;
        }
        .content .landscape-img {
            width: 100%;
            max-width: 100%;
            height: auto;
            margin-bottom: 0px;
            border-radius: 5px;
        }
        .content h1 {
            font-size: 2.5em;
            color: #515151;
            margin-bottom: 10px;
        }
        .content h2 {
            font-size: 1.5em;
            color: #e74c3c;
            margin-top: 30px;
        }
        .content p {
            margin: 15px 0;
        }
        .content a {
            word-wrap: break-word;
        }
        .content pre {
            background: #f8f8f8;
            padding: 5px;
            border-left: 4px solid #3498db;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            line-height: 1.1;
            max-width: 100%;
            box-sizing: border-box;
        }
        .pic_description {
            margin-top: 0px;
            font-size: 12px;
            text-align: center;
        }
        .video-container {
            width: 100%;
            height: 0;
            padding-bottom: 56.25%;
            position: relative;
            margin-bottom: 0;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }
        .chart-container {
            margin: 20px 0;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 300px;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }
        .bar {
            width: 100px;
            background-color: #3498db;
            text-align: center;
            color: white;
            font-weight: 700;
            position: relative;
            border-radius: 5px 5px 0 0;
        }
        .bar-label {
            position: absolute;
            bottom: -25px;
            width: 100%;
            color: #333;
            font-size: 0.9em;
        }
        .bar-value {
            position: absolute;
            top: -25px;
            width: 100%;
            color: #333;
            font-size: 0.9em;
        }
        header, footer {
            box-sizing: border-box;
            max-width: 100vw;
        }
        footer {
            background-color: #5f1a04;
            color: white;
            text-align: center;
            padding: 20px;
            position: relative;
            bottom: 0;
            width: 100%;
            border-top: 4px solid #34495e;
        }
        footer a {
            color: #ecf0f1;
            margin: 0 10px;
        }
        footer p {
            margin: 5px 0;
        }
        .consent-popup {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 400px;
            margin: auto;
        }
        .consent-popup p {
            margin: 0 0 15px;
            font-size: 14px;
        }
        .consent-popup button {
            padding: 10px 20px;
            margin-right: 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .consent-popup button:hover {
            background: #2980b9;
        }
        .consent-popup .decline {
            background: #e74c3c;
        }
        .consent-popup .decline:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="consent-popup" id="consentPopup" style="display: none;">
        <p>We use cookies and analytics to improve your experience. By continuing, you agree to our <a href="privacy.html">Privacy Policy</a>.</p>
        <button onclick="acceptTracking()">Accept</button>
        <button class="decline" onclick="declineTracking()">Decline</button>
    </div>
    <noscript id="gtm-noscript"></noscript>

    <!-- Header -->
    <header>
        <a href="index.html"><img src="pics/logo.eng.png" alt="Lorye Go! Hong Kong Edition Logo" class="logo"></a>
        <h1>Lorye Go! Hong Kong Edition - News</h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="index.html#about">About</a>
            <a href="index.html#download">Download</a>
            <a href="https://github.com/entzyeung/LoryeGo">GitHub</a>
        </nav>
    </header>

    <!-- Main Content -->
    <div class="content">
        <div class="video-container">
            <iframe src="https://www.youtube.com/embed/z7JfpJKUDOw?autoplay=1&start=403&mute=1&loop=1&playlist=z7JfpJKUDOw" title="Lorye Go! Hong Kong under development in early stage." frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <p class="pic_description">Lorye Go! Hong Kong under development in early stage.</p>

        <h1>From Code to Bundle: <br>Debugging the macOS Freeze in Lorye Go!</h1>
        <p><em>Published on March 29, 2025 by Entz Yeung</em></p>

        <h2>What Happened</h2>
        <p>I developed a Pygame-based game called "Lorye Go! 香港版" and bundled it into a macOS application using PyInstaller. The game worked perfectly when running the <code>dist/main/main</code> executable directly in the Terminal, but when launched as a proper macOS app bundle (<code>dist/main.app</code>) via <code>open</code> or double-clicking, it consistently froze after the destination selection screen (e.g., after displaying "有結果啦！下一站是... 朗屏站!"). Despite the freeze, the game successfully uploaded stats data to databases, indicating that the core logic and network functionality were intact. The issue was specific to the <code>.app</code> bundle's execution environment on macOS 15.2.</p>

        <h2>What I Tried So Far</h2>
        <p><strong>Initial Testing and Observation:</strong></p>
        <p>I confirmed that <code>dist/main/main</code> worked fine, but <code>dist/main.app</code> froze after the destination selection. I verified that data exported well alone the pipeline, suggesting that the freeze was not related to network operations. I ran <code>dist/main.app/Contents/MacOS/main</code> directly in the Terminal and found that it worked, indicating that the issue was specific to the macOS app bundle context.</p>
        <p><strong>Debugging Attempts:</strong></p>
        <p>I added <code>DEBUG</code> messages to the <code>game_flow</code> function to trace the execution flow, such as <code>DEBUG: After game_title</code>, <code>DEBUG: After game_start</code>, and <code>DEBUG: After data_export</code>. I ran <code>dist/main.app/Contents/MacOS/main</code> directly and observed that the game progressed past the destination selection, with logs showing:</p>
        <pre>
DEBUG: After data_export
DEBUG: Starting turn for 1
Reset BGM to 'theme'.
DEBUG: Before player_transition
DEBUG: After player_transition for player 1
        </pre>
        <p>However, when launching <code>dist/main.app</code> via <code>open</code>, I didn’t see these debug messages in the Terminal because the standard output (stdout) was not captured (because I am running the .app file).</p>
        <p><strong>Capturing Debug Output:</strong></p>
        <p>I used macOS’s <code>log stream</code> command to capture system logs while running the <code>.app</code> bundle:</p>
        <pre>
log stream --predicate 'process == "main"'
        </pre>
        <p>This revealed the root cause of the crash:</p>
        <pre>
2025-03-29 12:40:12.104278+0000 0x111f1d   Default     0x0                  864    0    main: [PYI-864:ERROR] Failed to execute script 'main' due to unhandled exception: [Errno 30] Read-only file system: 'screenshots'
        </pre>
        <p>The error indicated that the game was attempting to create a <code>screenshots</code> directory using <code>os.makedirs("screenshots", exist_ok=True)</code>, but failed because the current working directory (<code>/</code>) was read-only when launched as an <code>.app</code> bundle. This is originated from a function I created to let the player screen capture the game screen but it renders no error in Win's binary file. That's exactly why in my opinion it is still not time for AI to replace human yet. </p>

        <h2>How I Debugged</h2>
        <p><strong>Added Debug Messages:</strong></p>
        <p>I inserted <code>DEBUG</code> messages in the <code>game_flow()</code> function to trace the execution flow, such as <code>DEBUG: After data_export</code> and <code>DEBUG: Starting turn for ...</code>. I modified the <code>custom_print()</code> function to actually print to the console:</p>
        <pre>
def custom_print(*args, is_hud_message=False):
    message = " ".join(str(arg) for arg in args)
    print(message)
        </pre>
        <p><strong>Ran the Binary Directly:</strong></p>
        <p>I ran <code>dist/main.app/Contents/MacOS/main</code> in the Terminal to compare its behavior with launching the <code>.app</code> bundle via <code>open</code>. This helped confirm that the issue was specific to the macOS app bundle context.</p>
        <p><strong>Used System Logs:</strong></p>
        <p>Since launching via <code>open</code> didn’t show debug output in the Terminal, I used <code>log stream</code> to capture system logs, which revealed the <code>OSError: [Errno 30] Read-only file system</code> error.</p>
        <p><strong>Analyzed the Error:</strong></p>
        <p>The traceback pointed to the <code>os.makedirs("screenshots", exist_ok=True)</code> call in the <code>game_flow()</code> function (line 3114), indicating that the game was trying to create a directory in a read-only location (<code>/</code>) when launched as an <code>.app</code> bundle.</p>

        <h2>Key Concepts to Learn</h2>
        <p><strong>macOS App Bundle Execution Context:</strong></p>
        <p>When a macOS app bundle (<code>.app</code>) is launched via <code>open</code> or double-clicking, macOS sets the current working directory to the root directory (<code>/</code>), which is read-only for security reasons. This differs from running the binary directly, where the working directory is typically the directory containing the binary (e.g., <code>dist/main.app/Contents/MacOS/</code>), which is often writable.</p>

        <p><strong>File System Access in macOS Applications:</strong></p>
        <p>macOS applications should write to designated directories (e.g., the user’s home directory <code>~/</code>, <code>~/Documents</code>, or the app’s sandboxed container) rather than the current working directory, as the latter may be read-only or restricted.</p>
        <p><strong>Debugging macOS Applications:</strong></p>
        <p>Standard output (stdout) is not automatically directed to the Terminal when launching an <code>.app</code> bundle. Use <code>log stream</code> or redirect output to a file to capture debug messages. Example of redirecting output to a file:</p>
        <pre>
def custom_print(*args, is_hud_message=False):
    message = " ".join(str(arg) for arg in args)
    print(message)
    with open(os.path.join(os.path.expanduser("~"), "LoryeGoDebug.log"), "a") as f:
        f.write(f"{message}\n")
        </pre>

        <p><strong>PyInstaller and Resource Handling:</strong></p>
        <p>PyInstaller bundles the application and its resources, but it doesn’t control the runtime environment (e.g., the current working directory). Developers must ensure that file operations are performed in safe, writable locations.</p>
        <p><strong>Error Handling:</strong></p>
        <p>So it is a good reminder for me to bemindful to always wrap file operations in <code>try-except</code> blocks to handle potential errors gracefully, especially when dealing with file system access in cross-platform applications.</p>

        <h2>How I Solved It in the End</h2>
        <p>To resolve the issue, I made the screenshot functionality a no-op (no operation) by commenting out the code that attempted to create the <code>screenshots</code> directory and save screenshots. This eliminated the file system operation that was causing the crash. Here’s how I did it:</p>
        <p><strong>Commented Out Directory Creation:</strong></p>
        <p>In the <code>game_flow()</code> function, I commented out the line that creates the <code>screenshots</code> directory:</p>
        <pre>
# os.makedirs("screenshots", exist_ok=True)  # Commented out to avoid directory creation
        </pre>
        <p>This prevented the game from attempting to create a directory in the read-only root directory (<code>/</code>).</p>
        <p><strong>Commented Out Screenshot Saving Logic:</strong></p>
        <p>In the event handling loop of the <code>game_flow()</code> function, I commented out the block that saves screenshots when the <code>S</code> key is pressed. This ensured that no file system operations related to screenshots were attempted.</p>

        <p><strong>Rebuilt the App:</strong></p>
        <p>I rebuilt the app using PyInstaller:</p>
        <pre>
pyinstaller -w --add-data "assets:assets" --add-data "sub.py:." --add-data "map.py:." --add-data "question.py:." --icon "assets/icon.icns" main.py
        </pre>
        <p><strong>Tested the .app Bundle:</strong></p>
        <p>I launched the <code>.app</code> bundle using:</p>
        <pre>
open /Users/lorentzyeung/Desktop/Lorye/v994/dist/main.app
        </pre>
        <p>The game proceeded past the destination selection without crashing, confirming that the issue was resolved.</p>

        <h2>Final Outcome</h2>
        <p>By making the screenshot functionality a no-op, I eliminated the file system operation that was failing due to the read-only root directory when the <code>.app</code> bundle was launched. This allowed the game to run successfully in the macOS app bundle context. If I need to reintroduce screenshot functionality in the future, I should create the directory in a writable location (e.g., <code>~/LoryeGoScreenshots</code>) and handle file system errors gracefully.</p>

    </div>

    <!-- Footer -->
    <footer>
        <p>Developed by Entz Yeung</p>
        <p><a href="https://github.com/entzyeung">GitHub Profile</a> | <a href="/cdn-cgi/l/email-protection#a8cdc6dcd2d1cdddc6cfe8cfc5c9c1c486cbc7c5">Contact</a></p>
        <p><a href="index.html">Back to Lorye Go! Homepage</a></p>
        <p>© 2025 Lorye Go! Hong Kong Edition. All rights reserved.</p>
    </footer>

    <!-- Consent -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="consent.js"></script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'927fd394de0b53d3',t:'MTc0MzI1NjEyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>